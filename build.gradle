description = 'hub content feed'

apply plugin: 'idea'
apply plugin: 'java'
apply plugin: 'groovy'
apply plugin: 'org.springframework.boot'

repositories {
    mavenCentral()
}

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath(
                'org.springframework.boot:spring-boot-gradle-plugin:1.4.3.RELEASE',
        )
    }
}

sourceSets {
    functionaltest {
        compileClasspath = sourceSets.main.output + configurations.testRuntime
        runtimeClasspath = output + sourceSets.main.output + configurations.testRuntime
        groovy {
            srcDir 'src/functionaltest'
        }
        resources.srcDir file('src/functionaltest/resources')
    }
}

sourceCompatibility = 1.8
targetCompatibility = 1.8

dependencies {
    compile 'org.springframework.boot:spring-boot-starter-web'
    compile 'org.springframework.boot:spring-boot-starter-actuator'
    compile 'ch.qos.logback:logback-core:1.1.7'

    compile 'org.apache.commons:commons-lang3:3.3.2'
    compile 'org.apache.httpcomponents:httpclient:4.5.2'

    compile 'org.postgresql:postgresql:9.4.1208'
    compile 'com.jayway.jsonpath:json-path:2.1.0'

    compileOnly 'org.projectlombok:lombok:1.16.10'

    testCompile 'junit:junit:4.12'
    testCompile 'org.spockframework:spock-core:1.0-groovy-2.4'
    testCompile 'org.codehaus.groovy:groovy-all:2.4.7'
    testCompile 'cglib:cglib-nodep:3.1'
    testCompile 'org.hamcrest:hamcrest-core:1.3'
    testCompile 'org.springframework.boot:spring-boot-starter-test'
    testCompile 'org.springframework:spring-test:4.3.5.RELEASE'
}

//test {
//    systemProperty 'JDBC_DATABASE_URL', 'jdbc:postgresql://localhost:5432/hub_metadata'
//}

task functionaltest(type: Test) {
    System.setProperty( 'JDBC_DATABASE_URL', 'jdbc:postgresql://localhost:5432/hub_metadata')
    System.out.println('PRINT JDBC************************')
    System.out.println(System.getProperty('JDBC_DATABASE_URL'))
    testClassesDir = sourceSets.functionaltest.output.classesDir
    classpath = sourceSets.functionaltest.runtimeClasspath
    outputs.upToDateWhen { false }
}

//functionaltest {
//
//}

task wrapper(type: Wrapper) {
    gradleVersion = '3.1'
}

tasks.withType(Test) {
    reports.html.destination = file("${reporting.baseDir}/${name}")
}

test {
    testLogging {
        events "passed", "skipped", "failed", "standardOut", "standardError"
        exceptionFormat = 'full'
    }
}

bootRun {
    // support passing -Dsystem.property=value to bootRun task
    systemProperties = System.properties
}

task stage(type: Copy, dependsOn: [clean, build]) {
    from jar.archivePath
    into project.rootDir
    rename {
        'hub-content-feed.jar'
    }
}
stage.mustRunAfter(clean)

clean << {
    project.file('hub-content-feed.jar').delete()
}

//task stage(dependsOn: ['build', 'clean'])
//build.mustRunAfter clean